***

## Purpose of this Lambda function

This Lambda function, named **create\_quiz**, is used by the QnA Bedrock Agent to **dynamically generate and initialize a new quiz** for a user.

It identifies the user's recommended certification, uses **Amazon Bedrock** to create a set of custom, exam-style questions on a given topic, and persists all the quiz metadata and questions to DynamoDB before returning the first question to the user.

---

## Key Responsibilities

1️) Parse and Determine Parameters

The function extracts and validates the **required** `username` parameter. It also determines optional parameters:
* **username** (String, required)
* **topic** (String, optional, default: 'AWS General')
* **num\_questions** (Integer, optional, default: 5)

The `username` is converted to lowercase for lookup consistency.

2️) Retrieve User's Recommended Certification

* **Read from User Profile Table:** Looks up the user's record in the **user\_profile** table (using environment variable `USER_PROFILE_TABLE`).
* Extracts the `recommended_cert` value (e.g., "AWS Certified Solutions Architect").
* If the field is missing, it defaults to **'AWS Certified Cloud Practitioner'**.

3️) Generate Quiz Questions (Bedrock Integration)

* Calls the `generate_questions_with_bedrock` helper function.
* Sends a prompt to a **Bedrock foundation model** (`us.amazon.nova-pro-v1:0`), instructing it to generate a specified number of exam-style questions for the determined certification and topic.
* **The model returns a strict JSON array** containing the `question` text, `options` (exactly 4), and the `correct_answer` index (0-3).

4️) Create Quiz and Store Data in DynamoDB

* **Generates a unique quiz\_id** (using `uuid.uuid4()`).
* **Write to Quiz Table:** Creates a new item in the **quiz** table (using environment variable `QUIZ_TABLE`) to store metadata:
    * `id` (The generated `quiz_id`)
    * `username`
    * `topic`
    * `recommended_cert`
    * `max_score` (`num_questions`)
    * `user_score` (Initialized to 0)
    * `created_at` timestamp
* **Write to Question Table:** Iterates through the questions generated by Bedrock and creates a new item for each in the **question** table (using environment variable `QUESTION_TABLE`):
    * `quiz_id`
    * `order` (1 to `num_questions`)
    * `question`, `options`, `correct_answer` (from Bedrock output)
    * `user_score` (Initialized to 0)

5️) Return First Question

* Extracts the first generated question.
* Prepares a response body containing the new `quiz_id`, total question count, and the details of the first question (`order`, `question`, `options`).
* Returns the result in the standard **Bedrock Agent-compatible response format** with HTTP 200.

---

## Error Handling

The function handles different failure scenarios with proper HTTP status codes:

| Scenario | Status | Message |
| :--- | :--- | :--- |
| **Missing required input** (`username`) | **400** | "username is required" |
| **User not found** (in `user_profile` table) | **404** | "User 'X' not found" |
| **Bedrock/Generation Failure** (e.g., Bedrock API failure, or invalid JSON output from model) | **500** | "Failed to generate questions" |
| **DynamoDB ClientError** (on read or write) | **500** | "DynamoDB error: ..." |
| **Any other exception** | **500** | "Unhandled exception: ..." |

All errors are logged to CloudWatch.

---

## Typical Flow Example

User asks: **"Start me a 10-question quiz on VPC networking."**

* QnA agent invokes **create\_quiz** with `{ "username": "john_doe", "topic": "VPC networking", "num_questions": 10 }`.
* Lambda looks up `user_profile` for "john\_doe" → `recommended_cert` = 'AWS Certified Solutions Architect'.
* Lambda calls **Bedrock** to generate 10 questions on 'VPC networking' for the 'Solutions Architect' level.
* Lambda generates a new `quiz_id` (e.g., "quiz-a1b2c3d4").
* Lambda writes the quiz metadata to the **quiz** table.
* Lambda writes all 10 questions to the **question** table.
* Lambda returns the **`quiz_id` and the text/options for Question 1** to the agent.
* Agent displays the first question to the user.
